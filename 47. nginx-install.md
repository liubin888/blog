
### Nginx安装使用


#### For RHEL/CentOS
```sh
$ sudo yum install yum-utils

#手动写入rpm源
# 在  /etc/yum.repos.d/nginx.repo 写入如下内容

[nginx-stable]
name=nginx stable repo
baseurl=http://nginx.org/packages/centos/$releasever/$basearch/
gpgcheck=1
enabled=1
gpgkey=https://nginx.org/keys/nginx_signing.key

[nginx-mainline]
name=nginx mainline repo
baseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/
gpgcheck=1
enabled=0
gpgkey=https://nginx.org/keys/nginx_signing.key

$ sudo yum-config-manager --enable nginx-mainline
$ sudo yum install nginx

```
>其他平台 直接 访问 [http://nginx.org/en/linux_packages.html#stable](http://nginx.org/en/linux_packages.html#stable)


>nginx.pid 失败问题
执行
sudo nginx -c /usr/local/etc/nginx/nginx.conf
sudo nginx -s reload #重启
sudo nginx -t #测试配置文件

#### nginx 反向代理
```sh
server {
    listen       80 default_server;
    listen       [::]:80 default_server;
    server_name  chuchur.com www.chuchur.com;
    #/rest开头的转到7002
    location /rest {
        proxy_pass http://127.0.0.1:7002;
        proxy_redirect  off;
        proxy_set_header        HOST  $host;
        proxy_set_header        X-Real-IP       $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_send_timeout      300;
        proxy_read_timeout      300;
    }

    #转发到7001
    location / {
        proxy_pass http://127.0.0.1:7001;
        proxy_redirect  off;
        proxy_set_header        HOST  $host;
        proxy_set_header        X-Real-IP       $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_send_timeout      300;
        proxy_read_timeout      300;
    }
}
```
#### nginx 负载均衡

```sh
#gzip on
upstream node_server{
    server 192.168.0.1:8001 weight=10;
    server 192.168.0.2:8001 weight=20;
}

server{
    listen 80;
    server_name localhost;

    location /{
        proxy_pass http://node_server;
        root html;
        index index.html index.htm;
    }
}
```
#### nignx 缓存
```sh
#图片等资源缓存30天
location ~ \.(gif|jpg|jpeg|png|bmp|ico)$ {
    root /var/www/img/;
    expires 30d; #支持 时(h)分(s)秒(m)
}
#视频媒体资源永久缓存
location ~ \.(wma|wmv|asf|mp3|mmf|zip|rar|swf|flv)$ {
    root /var/www/upload/;
    expires max;

    #禁止缓存，每次都从服务器请求
    #add_header Cache-Control no-store;
}

```
#### nignx websocket 
```sh
location /ws/ {
    proxy_set_header Host $host;
    proxy_http_version 1.1; #必须
    proxy_set_header Upgrade $http_upgrade;#必须
    proxy_set_header Connection "upgrade";#必须
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    ........
}
```

#### nginx 防盗链
```sh
location ~* \.(gif|jpg|png|jpeg)$ {
    expires     30d;
    valid_referers none blocke *.chuchur.com www.chuchur.com m.chuchur.com *.baidu.com *.google.com;
    if ($invalid_referer) {
        rewrite ^/ http://chuchur.cn/404.jpg;
    }
}
```
* ~*.(jpg|gif|swf)$: 匹配不区分大小写，以.jpg 或.gif或 .swf结尾的文件。
* valid_referers：设置信任的网站，可以正常使用图片。
* none：浏览器中refer为空的情况，就是直接在浏览器访问图片。
* blocked：浏览器中refer不为空的情况，但是值被代理或防火墙删除了，这些值不以http://或 https://开头。
* 后面的网址或域名：refer包含相关字符串的网址。
* if语句：如果链接的来源域名不在valid_referers所列出的列表中， $invalid_referer 为1，则执行后面的操作，即进行重写或* 返回403页面。



#### nginx for Vue 
```sh
server {
    listen       80 default_server;
    listen       [::]:80 default_server;
    server_name  chuchur.com www.chuchur.com;
    location / {
        root ~/www/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
} 

```
>其他服务器vue部署 请参阅 [Vue部署](https://router.vuejs.org/zh/guide/essentials/history-mode.html#后端配置例子)

#### https
nginx 如何开启https 和http2 [(传送门)](//chuchur.com/article/web-https-http2)

ningx css 字体的支持，需要修改mime.types
加入以下代码
```sh
application/octet-stream eot;
application/font-sfnt ttf;
application/font-otf otf;
application/font-woff2 woff2;
application/font-woff woff;
```
>如果是跨域的话，还需要做跨域配置
```sh
location ~* .(eot|ttf|woff|svg|otf)$ {
  add_header Access-Control-Allow-Origin *;
}
```
#### location 优先级
- [=]模式: location = path,此种模式优先级最高（但要全路径匹配） 
- [^~]模式:location ^~ path,此种模式优先级第二高于正则； 
- [~ or ~*]模式:location ~ path,正则模式，优先级第三，[~]正则匹配区分大小写，[~*]正则匹配不区分大小写； 
- [path]模式: location path,中间什么都不加，直接跟路径表达式； 
>注意：一次请求只能匹配一个location，一旦匹配成功后，便不再继续匹配其余location;

#### 隐藏nignx版本号
```sh
#将Nginx的配置文件中的server_tokens选项值设置为off，如没有该配置项，加上即可。
vim /usr/local/nginx/conf/nginx.conf  
...........    #省略内容
    http {
       include       mime.types;
       default_type  application/octet-stream;
       server_tokens     off;    #关闭版本号
............    #省略内容
```

#### 相关命令
```sh
nginx -t #检查查看配置文件路径,其配置是否正确
nginx -s reload # 重启
nginx -s quit #退出
ningx -s stop #停止
```